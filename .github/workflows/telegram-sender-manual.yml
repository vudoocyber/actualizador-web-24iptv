name: Envio Manual de programacion Completa a Telegram

on:
  workflow_dispatch:
  repository_dispatch:

jobs:
  enviar_mensaje:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout del repositorio
      uses: actions/checkout@v4

    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Instalar dependencias
      # Dependencias necesarias para el env√≠o y manejo de fechas
      run: pip install requests python-dateutil pytz

    - name: Ejecutar script de envio a Telegram
      # Configuramos la variable TZ para la validaci√≥n de fecha/hora en M√©xico
      run: python enviar_telegram.py
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        URL_MENSAJE_TELEGRAM_TXT: ${{ secrets.URL_MENSAJE_TELEGRAM_TXT }}
        TZ: America/Mexico_City # Establece la zona horaria para la validaci√≥n del script

    # ----------------------------------------------------------------------
    # ‚úÖ NOTIFICACI√ìN DE √âXITO (Para Telegram)
    # ----------------------------------------------------------------------
    - name: Notificar √âxito a Telegram Personal
      if: success()
      run: |
        MENSAJE="‚úÖ **√âXITO:** El script para env√≠o de la programaci√≥n diara se ejecuto correctamente."
        MENSAJE="${MENSAJE}%0A**Workflow:** ${{ github.workflow }}"
        MENSAJE="${MENSAJE}%0AEl mensaje con todos los eventos del dia fue enviado correctamente al canal de Telegram. üëç"
        
        curl -s -X POST \
          "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_PERSONAL_CHAT_ID }}" \
          -d "text=$MENSAJE" \
          -d "parse_mode=Markdown"

    # ----------------------------------------------------------------------
    # ‚ùå NOTIFICACI√ìN DE FALLO (Para Telegram)
    # ----------------------------------------------------------------------
    - name: Notificar Fallo a Telegram Personal
      if: failure()
      run: |
        MENSAJE="‚ùå **FALLO CR√çTICO:** El env√≠o manual de la programaci√≥n completa ha fallado."
        MENSAJE="${MENSAJE}%0A%0A**Workflow:** ${{ github.workflow }}"
        MENSAJE="${MENSAJE}%0A%0A**Revisi√≥n:** Revise el log de Actions Github para m√°s detalles.üßê"
        
        curl -s -X POST \
          "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_PERSONAL_CHAT_ID }}" \
          -d "text=$MENSAJE" \
          -d "parse_mode=Markdown"
