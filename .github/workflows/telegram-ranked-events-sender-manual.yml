name: Envio Manual eventos Rankeados a Telegram

on:
  workflow_dispatch:
  repository_dispatch:

jobs:
  enviar_ranking:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout del repositorio
      uses: actions/checkout@v4

    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Instalar dependencias
      # Dependencias necesarias para el env√≠o y manejo de fechas
      run: pip install requests python-dateutil

    - name: Ejecutar script de envio de ranking
      run: python enviar_eventos_rankeados_telegram.py
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        URL_EVENTOS_JSON: ${{ secrets.URL_EVENTOS_JSON }}
        URL_RANKING_JSON: ${{ secrets.URL_RANKING_JSON }}
        TELEGRAM_ALERT_CHAT_ID: ${{ secrets.TELEGRAM_ALERT_CHAT_ID }} 
        TZ: America/Mexico_City # Zona horaria para validaci√≥n del script

    # ----------------------------------------------------------------------
    # ‚úÖ NOTIFICACI√ìN DE √âXITO (Para Telegram)
    # ----------------------------------------------------------------------
    - name: Notificar √âxito a Telegram Personal
      if: success()
      run: |
        MENSAJE="‚úÖ **√âXITO:** El env√≠o de los 3 eventos mas relevantes del dia por telegram ha finalizado."
        MENSAJE="${MENSAJE}%0A**Workflow:** ${{ github.workflow }}"
        MENSAJE="${MENSAJE}%0AEl resumen eventos fue enviado correctamente al canal de Telegram. üëç"
        
        curl -s -X POST \
          "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_PERSONAL_CHAT_ID }}" \
          -d "text=$MENSAJE" \
          -d "parse_mode=Markdown"

    # ----------------------------------------------------------------------
    # ‚ùå NOTIFICACI√ìN DE FALLO (Para Telegram)
    # ----------------------------------------------------------------------
    - name: Notificar Fallo a Telegram Personal
      if: failure()
      run: |
        MENSAJE="‚ùå **FALLO CR√çTICO:** El env√≠o manual de eventos rankeados ha fallado."
        MENSAJE="${MENSAJE}%0A%0A**Workflow:** ${{ github.workflow }}"
        MENSAJE="${MENSAJE}%0A%0A**Revisi√≥n:** Revise el log de Actions Github para m√°s detalles.üßê"
        
        curl -s -X POST \
          "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_PERSONAL_CHAT_ID }}" \
          -d "text=$MENSAJE" \
          -d "parse_mode=Markdown"
